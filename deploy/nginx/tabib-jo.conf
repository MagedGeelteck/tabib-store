# Nginx config for tabib-jo.com
# Save this as /etc/nginx/sites-available/tabib-jo.conf (or your distro's site config)
# Then symlink to sites-enabled and reload nginx: sudo ln -s /etc/nginx/sites-available/tabib-jo.conf /etc/nginx/sites-enabled/
# Test: sudo nginx -t && sudo systemctl reload nginx

# 1) Redirect all HTTP -> HTTPS and www -> non-www in one shot
server {
    listen 80;
    listen [::]:80;
    server_name tabib-jo.com www.tabib-jo.com;

    # Redirect everything to canonical https://tabib-jo.com
    return 301 https://tabib-jo.com$request_uri;
}

# 2) Handle requests to https://www.tabib-jo.com and redirect to https://tabib-jo.com
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.tabib-jo.com;

    # SSL certificate (Let's Encrypt paths used as example)
    ssl_certificate /etc/letsencrypt/live/tabib-jo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tabib-jo.com/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf; # optional: your ssl settings

    # Redirect to canonical non-www
    return 301 https://tabib-jo.com$request_uri;
}

# 3) Main site server block (canonical host)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name tabib-jo.com;

    root /var/www/tabib-jo/public; # <--- update to your actual project 'public' path
    index index.php index.html;

    ssl_certificate /etc/letsencrypt/live/tabib-jo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tabib-jo.com/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf;

    # Security headers (recommended)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Serve static assets directly
    location ~* \.(jpg|jpeg|gif|css|png|js|ico|svg|webp|ttf|woff|woff2)$ {
        expires 30d;
        access_log off;
        try_files $uri $uri/ =404;
    }

    # Laravel/Botble front controller
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        # Use the correct php-fpm unix socket or host:port for your setup
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS on;
        include fastcgi_params;
    }

    # Deny access to hidden files, .env, etc.
    location ~ /\.(env|git|ht) {
        deny all;
    }

    # disable access to storage/app/private if any
    location ~ ^/storage/.*\.php$ {
        deny all;
    }

    # Logging / other directives follow your site's conventions
}
